<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Panel de Referidos</title>

<style>
:root{
  --bg1:#e0eafc; --bg2:#cfdef3;
  --card: #ffffffdd; --text:#0b1220; --muted:#586a84; --border:#e5eaf0;
  --brand1:#5c6bc0; --brand2:#3f51b5; --ring: rgba(92,107,192,.25);
  --good1:#43a047; --good2:#66bb6a; --warn1:#fdd835; --warn2:#fff176; --vio1:#ab47bc; --vio2:#ce93d8;
}
* { box-sizing:border-box; margin:0; padding:0 }
html,body { height:100%; font-family:Inter, system-ui, sans-serif; }
body {
  background: linear-gradient(120deg, var(--bg1), var(--bg2));
  color: var(--text);
}

.container{
  max-width: 1140px; margin: 32px auto; padding: 24px;
  background: var(--card); backdrop-filter: blur(8px);
  border-radius: 16px; border:1px solid var(--border);
  box-shadow: 0 14px 40px rgba(0,0,0,.12); animation: fadeIn .6s ease;
}
h2 { text-align:center; color:#2e3a59; margin-bottom: 18px; }

input, select {
  padding: 12px; border-radius:10px; border:1px solid #cfd7e3;
  margin-bottom: 12px; font-size: 1rem;
}
input:focus, select:focus {
  border-color: var(--brand1);
  box-shadow: 0 0 0 4px var(--ring);
}
.btn {
  background: linear-gradient(135deg, var(--brand1), var(--brand2));
  color:#fff; border:none; padding:12px 18px; border-radius:10px;
  cursor:pointer;
}
.btn.secondary { background:#fff; border:1px solid #cfd7e3; color:#102033; }
.stats, .comisiones { display:flex; flex-wrap:wrap; gap:16px; margin-bottom: 18px; }
.card { flex:1 1 260px; padding:22px; border-radius:14px; color:#fff; text-align:center; }
.blue{ background: linear-gradient(135deg, var(--brand2), var(--brand1)) }
.green{ background: linear-gradient(135deg, var(--good1), var(--good2)) }
.yellow{ background: linear-gradient(135deg, var(--warn1), var(--warn2)); color:#3a3a3a }
.purple{ background: linear-gradient(135deg, var(--vio1), var(--vio2)) }
.table-container { overflow-x:auto; border-radius:10px; }
table { width:100%; border-collapse:collapse; background:#fff; }
thead th { background: var(--brand1); color:white; padding:12px; }
tbody td { padding:12px; border-bottom:1px solid #eef1f6; }
.no-data{ text-align:center; padding:36px; color:#7b8aa5; }
#modal { display:none; position:fixed; inset:0; background:rgba(33,33,33,.7);
  z-index:20; align-items:center; justify-content:center;
}
.modal-content { background:#fff; padding:24px 22px; border-radius:12px; text-align:center; width:min(420px, 92%); }
</style>
</head>
<body>
<div class="container">
  <h2>Panel de Referidos</h2>

  <div>
    <input type="text" id="referralLink" readonly>
    <button class="btn" id="copyBtn">Copiar</button>
  </div>

  <div class="stats">
    <div class="card blue">
      <h3>Total Referidos</h3>
      <p id="totalReferidos">0</p>
    </div>
    <div class="card green">
      <h3>Referidos Activos</h3>
      <p id="referidosActivos">0</p>
    </div>
  </div>

  <div class="comisiones">
    <div class="card yellow">
      <h3>Comisiones Totales</h3>
      <p id="comisionesTotales">0.00 créditos</p>
    </div>
    <div class="card purple">
      <h3>Comisiones Pendientes</h3>
      <p id="comisionesPendientes">0.00</p>
      <button id="btnCobrar" class="btn">Cobrar Comisiones</button>
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Usuario / Correo</th>
          <th>Fecha Registro</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="referidosTable">
        <tr><td colspan="3" class="no-data">No se encontraron referidos</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="modal">
  <div class="modal-content">
    <h3>¿Deseas cobrar tus comisiones pendientes?</h3>
    <button class="btn" id="confirmCobrar">Sí, cobrar</button>
    <button class="btn secondary" id="cancelCobrar">Cancelar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyB28uLNC-7NBDBSJeQJ1Li_bYR6ygbf0DI",
  authDomain: "transferencia-88fd7.firebaseapp.com",
  databaseURL: "https://transferencia-88fd7-default-rtdb.firebaseio.com",
  projectId: "transferencia-88fd7",
  storageBucket: "transferencia-88fd7.appspot.com",
  messagingSenderId: "343352831024",
  appId: "1:343352831024:web:9ac2d08b41874b15e611f5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const $ = s=>document.querySelector(s);
let usernameGlobal = null;

// Copiar enlace
$('#copyBtn').onclick = async ()=>{
  await navigator.clipboard.writeText($('#referralLink').value);
  alert('Enlace copiado');
};

// Cobrar comisiones
$('#btnCobrar').onclick = ()=> $('#modal').style.display='flex';
$('#cancelCobrar').onclick = ()=> $('#modal').style.display='none';
$('#confirmCobrar').onclick = async ()=>{
  const userSnap = await db.ref(`usuarios/${usernameGlobal}`).once('value');
  const u = userSnap.val() || {};
  const pend = Number(u.comisionesPendientes||0);
  const tot = Number(u.comisionesTotales||0);
  if(pend>0){
    await db.ref(`usuarios/${usernameGlobal}`).update({
      comisionesPendientes:0,
      comisionesTotales: tot + pend
    });
  }
  $('#modal').style.display='none';
};

// Cargar datos
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href='login.html';
  const userDataSnap = await db.ref(`usuarios`).orderByChild('correo').equalTo(user.email).once('value');
  let username = null;
  userDataSnap.forEach(s=>{ username = s.val().nombre; });
  if(!username) return alert('No se encontró tu usuario');

  usernameGlobal = username;
  $('#referralLink').value = `${location.origin}/referido/${username}`;

  db.ref(`referidos/${username}`).on('value', snap=>{
    const data = snap.val() || {};
    const list = Object.values(data);
    $('#totalReferidos').textContent = list.length;
    const activos = list.filter(r=>r.estado==='activo');
    $('#referidosActivos').textContent = activos.length;
    $('#comisionesPendientes').textContent = (activos.length*10).toFixed(2);
    $('#referidosTable').innerHTML = list.map(r=>`
      <tr>
        <td>${r.nombre || '-'} / ${r.correo || '-'}</td>
        <td>${r.fecha || '-'}</td>
        <td>${r.estado || '-'}</td>
      </tr>`).join('');
    db.ref(`usuarios/${username}`).update({comisionesPendientes: activos.length*10});
  });

  db.ref(`usuarios/${username}`).on('value', s=>{
    const u = s.val() || {};
    $('#comisionesTotales').textContent = (u.comisionesTotales||0).toFixed(2)+' créditos';
  });
});
</script>
</body>
</html>
