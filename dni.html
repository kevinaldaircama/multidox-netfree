<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Consulta doxin ¬∑ por DNI</title>
<link rel="icon" href="3440119_ico.png" />
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

<style>
  :root{--bg:#f5f7fb;--card:#fff;--text:#0b1220;--muted:#6b7280;--pri:#2563eb;--priH:#1e40af;--ring:rgba(37,99,235,.25);--ok:#16a34a;--warn:#b45309;--err:#b91c1c}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
  .wrap{max-width:960px;margin:20px auto;padding:16px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:18px}
  h1{margin:0 0 6px}
  p.sub{color:var(--muted);margin:0 0 14px}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px}
  input[type="text"]{padding:12px;border:1px solid #d1d5db;border-radius:10px;outline:none}
  input[type="text"]:focus{border-color:var(--pri);box-shadow:0 0 0 4px var(--ring)}
  .btn{background:var(--pri);color:#fff;border:none;padding:12px 16px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn:hover{background:var(--priH)}
  .note{margin-top:12px;background:#fff3cd;border:1px solid #ffeeba;color:#856404;padding:12px;border-radius:10px}
  .status{margin-top:10px;display:none;border-radius:10px;padding:12px;font-weight:600}
  .status.loading{display:block;background:#eef2ff;border:1px solid #c7d2fe;color:#1e3a8a}
  .status.ok{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
  .status.warn{display:block;background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12}
  .status.err{display:block;background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  .small{font-size:.9rem;color:var(--muted)}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal.show{display:flex}
  .modal-card{background:#fff;color:#0b1220;width:min(880px,94vw);max-height:92vh;overflow:auto;border-radius:16px;padding:16px;border:1px solid #e5e7eb;box-shadow:0 24px 60px rgba(0,0,0,.3)}
  .modal-hd{display:flex;justify-content:space-between;align-items:center;gap:8px;border-bottom:1px solid #eef2f7;padding-bottom:8px}
  .close{background:transparent;border:none;font-size:22px;cursor:pointer}
  .flex{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px}
  .photo{flex:0 0 220px}
  .photo .box{border:1px dashed #cbd5e1;border-radius:12px;padding:10px;text-align:center}
  .photo img{width:100%;height:auto;border-radius:10px}
  .photo a{display:inline-block;margin-top:8px;font-size:.9rem}
  .cols{flex:1 1 320px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .blk{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .blk h3{margin:0 0 6px;font-size:1rem}
  .item{font-size:.95rem;margin:4px 0}
  .hl{font-weight:700}
  @media(max-width:720px){.cols{grid-template-columns:1fr}.photo{flex:1 1 100%}}
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Consulta doxin por DNI</h1>
      <p class="sub">Se descuentan <strong>3 cr√©ditos</strong> si la ficha existe. Se mostrar√° en un modal con la foto (URL).</p>

      <div class="row">
        <input id="dniInput" type="text" placeholder="Ingresa DNI..." />
        <button class="btn" id="btnBuscar">Buscar</button>
      </div>

      <div class="note">
        <strong>Importante:</strong> si la consulta no est√° disponible o falla, comun√≠cate con nosotros
        <a href="https://roddox.es/soporte app" target="_blank" style="font-weight:700;text-decoration:underline">aqu√≠</a>.
      </div>

      <div id="status" class="status"></div>
      <div class="small" style="margin-top:8px;">Necesitas sesi√≥n iniciada para descontar cr√©ditos desde RTDB.</div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttl">
    <div class="modal-card">
      <div class="modal-hd">
        <h2 id="ttl">Resultado de consulta</h2>
        <button class="close" id="closeModal" aria-label="Cerrar">√ó</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
  // ====== Config Firebase ======
  const firebaseConfig = {
    apiKey: "AIzaSyB28uLNC-7NBDBSJeQJ1Li_bYR6ygbf0DI",
    authDomain: "transferencia-88fd7.firebaseapp.com",
    databaseURL: "https://transferencia-88fd7-default-rtdb.firebaseio.com",
    projectId: "transferencia-88fd7",
    storageBucket: "transferencia-88fd7.firebasestorage.app",
    messagingSenderId: "343352831024",
    appId: "1:343352831024:web:9ac2d08b41874b15e611f5",
    measurementId: "G-LNX1B0RLK7"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const fs   = firebase.firestore();
  const rtdb = firebase.database();

  // ====== Helpers UI ======
  const $ = s => document.querySelector(s);
  const statusBox = $('#status');
  const show = (cls, msg) => { statusBox.className = 'status ' + cls; statusBox.innerHTML = msg; };

  const COSTO = 3; // cr√©ditos

  // Espera (ms)
  const wait = (ms)=> new Promise(res=>setTimeout(res, ms));

  // Render modal con datos
  function renderModal(data, creditosDisp, usuarioStr){
    const m = $('#modal'); const body = $('#modalBody');
    const f = data.foto || '';
    const N = (x)=> (x==null || x==='') ? '‚Äî' : x;

    body.innerHTML = `
      <div class="flex">
        <div class="photo">
          <div class="box">
            ${f ? `<img src="${f}" alt="Foto" />
                   <a href="${f}" target="_blank" rel="noopener">Abrir imagen en pesta√±a</a>`
                : `<div class="small">Sin foto</div>`}
          </div>
        </div>

        <div class="cols">
          <div class="blk">
            <h3>Identidad</h3>
            <div class="item"><span class="hl">DNI:</span> ${N(data.dni)}</div>
            <div class="item"><span class="hl">NOMBRES:</span> ${N(data.nombres)}</div>
            <div class="item"><span class="hl">APELLIDOS:</span> ${N(data.apellidos)}</div>
            <div class="item"><span class="hl">G√âNERO:</span> ${N(data.genero)}</div>
          </div>

          <div class="blk">
            <h3>Cuenta</h3>
            <div class="item"><span class="hl">Cr√©ditos disponibles:</span> ${Number(creditosDisp).toFixed(0)}</div>
            <div class="item"><span class="hl">Usuario:</span> ${N(usuarioStr)}</div>
          </div>

          <div class="blk">
            <h3>üéÇ Nacimiento</h3>
            <div class="item"><span class="hl">FECHA NACIMIENTO:</span> ${N(data.nacimiento?.fecha)}</div>
            <div class="item"><span class="hl">EDAD:</span> ${N(data.nacimiento?.edad)}</div>
            <div class="item"><span class="hl">DEPARTAMENTO:</span> ${N(data.nacimiento?.departamento)}</div>
            <div class="item"><span class="hl">PROVINCIA:</span> ${N(data.nacimiento?.provincia)}</div>
            <div class="item"><span class="hl">DISTRITO:</span> ${N(data.nacimiento?.distrito)}</div>
          </div>

          <div class="blk">
            <h3>üìã Informaci√≥n general</h3>
            <div class="item"><span class="hl">NIVEL EDUCATIVO:</span> ${N(data.general?.nivelEducativo)}</div>
            <div class="item"><span class="hl">ESTADO CIVIL:</span> ${N(data.general?.estadoCivil)}</div>
            <div class="item"><span class="hl">ESTATURA:</span> ${N(data.general?.estatura)}</div>
            <div class="item"><span class="hl">FECHA INSCRIPCI√ìN:</span> ${N(data.general?.fechaInscripcion)}</div>
            <div class="item"><span class="hl">FECHA EMISI√ìN:</span> ${N(data.general?.fechaEmision)}</div>
            <div class="item"><span class="hl">FECHA CADUCIDAD:</span> ${N(data.general?.fechaCaducidad)}</div>
            <div class="item"><span class="hl">DONANTE √ìRGANOS:</span> ${N(data.general?.donanteOrganos)}</div>
            <div class="item"><span class="hl">PADRE:</span> ${N(data.general?.padre)}</div>
            <div class="item"><span class="hl">MADRE:</span> ${N(data.general?.madre)}</div>
            <div class="item"><span class="hl">RESTRICCI√ìN:</span> ${N(data.general?.restriccion)}</div>
          </div>

          <div class="blk">
            <h3>üè† Domicilio</h3>
            <div class="item"><span class="hl">DEPARTAMENTO:</span> ${N(data.domicilio?.departamento)}</div>
            <div class="item"><span class="hl">PROVINCIA:</span> ${N(data.domicilio?.provincia)}</div>
            <div class="item"><span class="hl">DISTRITO:</span> ${N(data.domicilio?.distrito)}</div>
            <div class="item"><span class="hl">DIRECCI√ìN:</span> ${N(data.domicilio?.direccion)}</div>
          </div>

          <div class="blk">
            <h3>üìç Ubigeos</h3>
            <div class="item"><span class="hl">UBIGEO RENIEC:</span> ${N(data.ubigeos?.reniec)}</div>
            <div class="item"><span class="hl">UBIGEO INE:</span> ${N(data.ubigeos?.ine)}</div>
            <div class="item"><span class="hl">UBIGEO SUNAT:</span> ${N(data.ubigeos?.sunat)}</div>
          </div>
        </div>
      </div>
    `;
    m.classList.add('show');
  }

  $('#closeModal').addEventListener('click', ()=> $('#modal').classList.remove('show'));
  window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') $('#modal').classList.remove('show'); });

  // ====== L√≥gica de b√∫squeda ======
  $('#btnBuscar').addEventListener('click', async ()=>{
    const dni = ($('#dniInput').value || '').trim();
    if (!dni) { show('warn','‚ö†Ô∏è Ingresa un DNI.'); return; }

    // Etapa 1: Cargando‚Ä¶ (2s)
    show('loading','‚è≥ Cargando‚Ä¶');
    await wait(2000);

    try{
      const user = auth.currentUser;
      if (!user){
        show('warn','‚ö†Ô∏è Debes iniciar sesi√≥n para realizar consultas.');
        return;
      }

      // Buscar documento en Firestore primero
      const snap = await fs.collection('doxin').doc(dni).get();

      // Etapa 2: Verificando confirmaci√≥n‚Ä¶ (2s)
      show('loading','üîé Verificando confirmaci√≥n‚Ä¶');
      await wait(2000);

      if (!snap.exists){
        show('warn','‚ÑπÔ∏è No hay informaci√≥n en la base de datos para ese DNI.');
        return;
      }

      const data = snap.data() || {};

      // Leer cr√©ditos en RTDB y nombre de usuario (si se permite)
      let saldoActual = null;
      let usuarioStr = user.displayName || (user.email ? user.email.split('@')[0] : 'Usuario');

      try{
        const uSnap = await rtdb.ref(`usuarios/${user.uid}`).once('value');
        const uData = uSnap.val() || {};
        if (uData.nombre) usuarioStr = uData.nombre;
        saldoActual = Number(uData.comisionesTotales || 0);
      }catch(e){
        // Puede ser PERMISSION_DENIED. Continuaremos pero no podremos descontar.
        console.warn('RTDB read error:', e?.message);
      }

      // Si no pudimos leer saldoActual de RTDB, no podemos descontar
      if (saldoActual === null){
        show('err','‚ùå No se pudo leer tu saldo en Realtime Database (PERMISSION_DENIED). No podemos descontar cr√©ditos. Revisa reglas o ruta.');
        return;
      }

      // Validar cr√©ditos suficientes
      if (saldoActual < COSTO){
        show('warn','‚ö†Ô∏è No tienes cr√©ditos suficientes para realizar la consulta.');
        return;
      }

      // Transaction RTDB
      const okTx = await new Promise((resolve,reject)=>{
        rtdb.ref(`usuarios/${user.uid}/comisionesTotales`).transaction(curr=>{
          const v = Number(curr)||0;
          if (v < COSTO) return; // abort
          return v - COSTO;
        }, (err, committed, ss)=>{
          if (err) return reject(err);
          if (!committed) return reject(new Error('No se pudo descontar (saldo insuficiente o cambi√≥).'));
          resolve(ss);
        });
      }).then(()=>true).catch(e=>{
        console.error('RTDB tx error:', e);
        return false;
      });

      if (!okTx){
        show('err','‚ùå No se pudo descontar cr√©ditos. Intenta nuevamente.');
        return;
      }

      // Leer saldo actualizado para mostrarlo
      let saldoNuevo = saldoActual - COSTO;
      try{
        const uSnap2 = await rtdb.ref(`usuarios/${user.uid}/comisionesTotales`).once('value');
        saldoNuevo = Number(uSnap2.val() || saldoNuevo);
      }catch{}

      show('ok','‚úÖ Consulta lista. Abriendo resultado‚Ä¶');
      renderModal(data, saldoNuevo, usuarioStr);

    }catch(e){
      console.error(e);
      show('err','‚ùå Ocurri√≥ un error al procesar la consulta. Intenta nuevamente.');
    }
  });
</script>
</body>
</html>
