<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Consulta doxin1</title>

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg:#0f172a; --card:#0b1220; --muted:#7c8aa5; --text:#e6ecf5; --border:#1f2a44;
    --ring:#2f6efc33; --brand:#7c3aed; --ok:#14a44d; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; padding:16px; display:grid; place-items:center;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1200px 600px at 10% 10%, #1b2234 0, #0f172a 50%, #0b1220 100%);
    color:var(--text);
  }
  .card{
    width:100%; max-width:920px; background: linear-gradient(180deg, #0b1220, #0a1120);
    border:1px solid var(--border); border-radius:16px; padding:18px;
    box-shadow: 0 30px 60px rgba(0,0,0,.45);
  }
  h1{ margin:0 0 4px; font-size:clamp(20px, 4vw, 26px); font-weight:800; letter-spacing:.3px }
  p.sub{ margin:0 0 14px; color:var(--muted) }
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .row > *{ flex:1 }
  .row .col-fixed{ flex:0 0 auto }

  .input{ width:100%; padding:12px 14px; border-radius:10px; background:#0e1831;
    border:1px solid var(--border); color:var(--text); outline:none;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .input:focus{ border-color:#2f6efc; box-shadow:0 0 0 4px var(--ring) }
  .btn{ border:none; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:800 }
  .btn.primary{ background:#2f6efc; color:#fff }
  .btn.primary:hover{ filter:saturate(1.1) brightness(1.03) }

  .panel{
    margin-top:14px; padding:12px; border-radius:12px;
    background:linear-gradient(180deg, #0b1220, #0a1222);
    border:1px dashed #20335a;
  }
  .msg{ font-size:15px; color:#cbd5e1 }
  .loader{
    display:flex; align-items:center; gap:12px; padding:12px;
    background:#0a1222; border:1px solid #172445; border-radius:12px;
  }
  .spinner{
    width:22px; height:22px; border-radius:50%;
    border:3px solid #20345c; border-top-color:#2f6efc; animation:spin 1s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Modal base */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
          background: rgba(10, 12, 20, .65); z-index:20; padding:14px }
  .modal .content{
    width:min(960px, 96%); background:#0b1220; border:1px solid #20335a; border-radius:14px;
    box-shadow: 0 30px 60px rgba(0,0,0,.6); padding:14px;
  }
  .modal .head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px }
  .modal .title{ font-weight:800; font-size:18px }
  .modal .close{ color:#93a7c3; cursor:pointer; font-weight:700 }
  .modal .close:hover{ color:#cbd5e1 }

  /* Layout resultado */
  .grid{
    display:grid; grid-template-columns: 260px 1fr; gap:16px;
  }
  .photo{
    background:#0a1222; border:1px solid #20335a; border-radius:12px; padding:12px;
  }
  .photo .title{ font-weight:700; color:#9bb1d6; margin-bottom:10px }
  .photo img{
    width:100%; height:auto; border-radius:12px; display:block;
    background:#070e1c; border:1px solid #0f1c38; cursor:pointer;
  }

  .col{
    background:#0a1222; border:1px solid #20335a; border-radius:12px; padding:12px;
  }
  .col .title{ font-weight:700; color:#9bb1d6; margin:2px 0 8px }
  .pair{ display:flex; gap:8px; padding:6px 0; border-bottom:1px dashed #1a2a4c; font-size:14px }
  .pair:last-child{ border-bottom:none }
  .pair b{ min-width:180px; color:#a7b8d8 }

  hr{ border:0; border-top:1px solid #1a2a4c; margin:12px 0 }

  /* Modal foto grande */
  .modal-photo .content{
    width:min(720px, 94%); background:#0b1220; border:1px solid #20335a; padding:12px; border-radius:14px;
  }
  .modal-photo img{ width:100%; height:auto; border-radius:12px; display:block }

  /* Aviso soporte */
  .notice{
    background:#13233f; border:1px solid #273a61; color:#d9e2ef;
    padding:12px; border-radius:8px; margin-top:12px
  }
  .notice a{ color:#8be9ff; text-decoration:underline; font-weight:700 }

  /* Responsive */
  @media (max-width: 860px){
    .grid{ grid-template-columns: 1fr; }
    .pair{ flex-direction:column }
    .pair b{ min-width: auto }
  }
</style>
</head>
<body>
  <div class="card" role="region" aria-label="Consulta doxin1">
    <h1>Consulta doxin1</h1>
    <p class="sub">Ingresa el DNI para consultar. Se descuentan <b>3 cr√©ditos</b> por consulta exitosa.</p>

    <div class="row">
      <input id="dniBuscar" class="input" placeholder="DNI" inputmode="numeric" />
      <div class="col-fixed">
        <button id="btnBuscar" class="btn primary" type="button">Buscar</button>
      </div>
    </div>

    <div id="panel" class="panel">
      <div id="mensaje" class="msg">Listo para consultar.</div>
    </div>

    <!-- Aviso soporte -->
    <div class="notice">
      <h4 style="margin:0 0 6px;">Importante</h4>
      <div>Cr√©dito descontado por consulta: <b>3</b></div>
      <div style="margin-top:6px;">
        Recuerda que si la consulta no est√° disponible o falla, comun√≠cate con nosotros
        <a href="https://roddox.es/soporte app" target="_blank" rel="noopener">aqu√≠</a>.
      </div>
    </div>
  </div>

  <!-- Modal resultado -->
  <div id="modalResultado" class="modal" aria-modal="true" role="dialog">
    <div class="content">
      <div class="head">
        <div class="title">Resultado de la consulta</div>
        <span class="close" id="cerrarResultado">Cerrar</span>
      </div>

      <div id="resultadoWrap">
        <!-- Se llena por JS -->
      </div>
    </div>
  </div>

  <!-- Modal foto -->
  <div id="modalFoto" class="modal modal-photo" aria-modal="true" role="dialog">
    <div class="content">
      <div class="head">
        <div class="title">Foto</div>
        <span class="close" id="cerrarFoto">Cerrar</span>
      </div>
      <img id="fotoAmpliada" src="" alt="Foto ampliada" />
    </div>
  </div>

<script>
  // ---------- Firebase ----------
  const firebaseConfig = {
    apiKey: "AIzaSyB28uLNC-7NBDBSJeQJ1Li_bYR6ygbf0DI",
    authDomain: "transferencia-88fd7.firebaseapp.com",
    databaseURL: "https://transferencia-88fd7-default-rtdb.firebaseio.com",
    projectId: "transferencia-88fd7",
    storageBucket: "transferencia-88fd7.firebasestorage.app",
    messagingSenderId: "343352831024",
    appId: "1:343352831024:web:9ac2d08b41874b15e611f5",
    measurementId: "G-LNX1B0RLK7"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();
  const fs   = firebase.firestore();

  // ---------- Helpers UI ----------
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const mensaje = $('#mensaje');
  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
  const showLoader = (t)=> mensaje.innerHTML = `<div class="loader"><div class="spinner"></div><span>${t}</span></div>`;
  const showText = (t)=> mensaje.textContent = t;

  const openModal  = (id)=> $(id).style.display='flex';
  const closeModal = (id)=> $(id).style.display='none';
  $('#cerrarResultado').addEventListener('click', ()=> closeModal('#modalResultado'));
  $('#cerrarFoto').addEventListener('click', ()=> closeModal('#modalFoto'));
  $$('#modalResultado, #modalFoto').forEach(m=>{
    m.addEventListener('click', (e)=>{ if(e.target.classList.contains('modal')) e.currentTarget.style.display='none'; });
  });

  // ---------- Consulta ----------
  $('#btnBuscar').addEventListener('click', async ()=>{
    const dni = $('#dniBuscar').value.trim();
    if (!dni){ alert('Ingresa un DNI.'); return; }

    const user = auth.currentUser;
    if (!user){ showText('Debes iniciar sesi√≥n para consultar.'); return; }

    try{
      // Estado 1
      showLoader('‚è≥ Cargando‚Ä¶');
      await sleep(2000);

      // Estado 2
      showLoader('üîç Verificando confirmaci√≥n‚Ä¶');
      await sleep(2000);

      // Traer datos y saldo actual en paralelo
      const [docSnap, userSnap] = await Promise.all([
        fs.collection('doxin1').doc(dni).get(),      // <‚Äî tu colecci√≥n
        db.ref(`usuarios/${user.uid}`).once('value')
      ]);

      if (!docSnap.exists){
        showText('‚ùå No hay informaci√≥n en la base de datos para ese DNI.');
        return;
      }

      const userData = userSnap.val() || {};
      const saldoActual = Number(userData.comisionesTotales || 0);
      const usuarioNombre = userData?.nombre || (user.email?.split('@')[0]) || 'Usuario';

      if (isNaN(saldoActual) || saldoActual < 3){
        showText('‚ö†Ô∏è No tienes cr√©ditos suficientes para realizar la consulta.');
        return;
      }

      // Descontar 3 cr√©ditos usando transacci√≥n para evitar condiciones de carrera
      await db.ref(`usuarios/${user.uid}/comisionesTotales`).transaction((curr)=>{
        const v = Number(curr) || 0;
        if (v < 3) return;            // abortar√° la transacci√≥n (no descuenta)
        return v - 3;
      }, (err, committed)=>{
        if (err) throw err;
        if (!committed) throw new Error('No se pudo descontar cr√©ditos (saldo cambi√≥ o es insuficiente).');
      });

      // Render del resultado
      const d = docSnap.data() || {};
      const fotoUrl = d.foto || '';

      const html = `
        <div class="grid">
          <div class="photo">
            <div class="title">Foto</div>
            ${fotoUrl
              ? `<img id="miniFoto" src="${fotoUrl}" alt="Foto (toca para ampliar)">`
              : `<div style="color:#9aa7bd">Sin foto</div>`
            }
          </div>
          <div class="col">
            <div class="title">üßë‚Äçüíº Datos Personales</div>
            <div class="pair"><b>DNI:</b> ${d.dni ?? dni}</div>
            <div class="pair"><b>NOMBRES:</b> ${d.nombres ?? '-'}</div>
            <div class="pair"><b>APELLIDOS:</b> ${d.apellidos ?? '-'}</div>
            <div class="pair"><b>G√âNERO:</b> ${d.genero ?? '-'}</div>

            <div class="title" style="margin-top:8px">üéÇ Nacimiento</div>
            <div class="pair"><b>FECHA NACIMIENTO:</b> ${d.fechaNacimiento ?? '-'}</div>
            <div class="pair"><b>EDAD:</b> ${d.edad ?? '-'}</div>
            <div class="pair"><b>DEPARTAMENTO:</b> ${d.departamento ?? '-'}</div>
            <div class="pair"><b>PROVINCIA:</b> ${d.provincia ?? '-'}</div>
            <div class="pair"><b>DISTRITO:</b> ${d.distrito ?? '-'}</div>

            <div class="title" style="margin-top:8px">üìã Informaci√≥n General</div>
            <div class="pair"><b>NIVEL EDUCATIVO:</b> ${d.nivelEducativo ?? '-'}</div>
            <div class="pair"><b>ESTADO CIVIL:</b> ${d.estadoCivil ?? '-'}</div>
            <div class="pair"><b>ESTATURA:</b> ${d.estatura ?? '-'}</div>
            <div class="pair"><b>FECHA INSCRIPCI√ìN:</b> ${d.fechaInscripcion ?? '-'}</div>
            <div class="pair"><b>FECHA EMISI√ìN:</b> ${d.fechaEmision ?? '-'}</div>
            <div class="pair"><b>FECHA CADUCIDAD:</b> ${d.fechaCaducidad ?? '-'}</div>
            <div class="pair"><b>DONANTE √ìRGANOS:</b> ${d.donanteOrganos ?? '-'}</div>
            <div class="pair"><b>PADRE:</b> ${d.padre ?? '-'}</div>
            <div class="pair"><b>MADRE:</b> ${d.madre ?? '-'}</div>
            <div class="pair"><b>RESTRICCI√ìN:</b> ${d.restriccion ?? '-'}</div>

            <div class="title" style="margin-top:8px">üè† Domicilio</div>
            <div class="pair"><b>DEPARTAMENTO:</b> ${d.dom_departamento ?? '-'}</div>
            <div class="pair"><b>PROVINCIA:</b> ${d.dom_provincia ?? '-'}</div>
            <div class="pair"><b>DISTRITO:</b> ${d.dom_distrito ?? '-'}</div>
            <div class="pair"><b>DIRECCI√ìN:</b> ${d.direccion ?? '-'}</div>

            <div class="title" style="margin-top:8px">üìç Ubigeos</div>
            <div class="pair"><b>UBIGEO RENIEC:</b> ${d.ubigeoReniec ?? '-'}</div>
            <div class="pair"><b>UBIGEO INE:</b> ${d.ubigeoIne ?? '-'}</div>
            <div class="pair"><b>UBIGEO SUNAT:</b> ${d.ubigeoSunat ?? '-'}</div>

            <hr>
            <div class="pair"><b>Usuario:</b> ${usuarioNombre}</div>
          </div>
        </div>
      `;
      $('#resultadoWrap').innerHTML = html;
      showText('');
      openModal('#modalResultado');

      const mini = document.getElementById('miniFoto');
      if (mini){
        mini.addEventListener('click', ()=>{
          document.getElementById('fotoAmpliada').src = fotoUrl;
          openModal('#modalFoto');
        });
      }

    }catch(err){
      console.error('[Consulta error]', err);
      const code = err?.code ? ` (${err.code})` : '';
      const msg  = err?.message || 'Error desconocido';
      showText(`‚ùå Ocurri√≥ un error al procesar la consulta${code}: ${msg}`);
    }
  });

  // Mensaje inicial seg√∫n sesi√≥n
  auth.onAuthStateChanged(u=>{
    if (!u) showText('Debes iniciar sesi√≥n para consultar.');
    else    showText('Listo para consultar.');
  });
</script>
</body>
</html>
