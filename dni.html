<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Consulta doxin ¬∑ por DNI</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

<style>
  body{margin:0;background:#f5f7fb;font-family:Inter,sans-serif;color:#0b1220}
  .wrap{max-width:960px;margin:20px auto;padding:16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px}
  input{padding:12px;border:1px solid #d1d5db;border-radius:10px}
  .btn{background:#2563eb;color:#fff;border:none;padding:12px 16px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn:hover{background:#1e40af}
  .status{margin-top:10px;display:none;border-radius:10px;padding:12px;font-weight:600}
  .status.loading{display:block;background:#eef2ff;border:1px solid #c7d2fe;color:#1e3a8a}
  .status.warn{display:block;background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12}
  .status.err{display:block;background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  .status.ok{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}

  .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal.show{display:flex}
  .modal-card{background:#fff;width:min(880px,94vw);max-height:92vh;overflow:auto;border-radius:16px;padding:16px}
  .modal-hd{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eef2f7;padding-bottom:8px}
  .close{background:transparent;border:none;font-size:22px;cursor:pointer}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .blk{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .blk h3{margin:0 0 6px}
  .item{margin:4px 0}
  .hl{font-weight:700}
  @media(max-width:720px){.cols{grid-template-columns:1fr}}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Consulta doxin por DNI</h1>
    <div class="row">
      <input id="dniInput" type="text" placeholder="Ingresa DNI..." />
      <button class="btn" id="btnBuscar">Buscar</button>
    </div>
    <div id="status" class="status"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-card">
    <div class="modal-hd">
      <h2>Resultado</h2>
      <button class="close" id="closeModal">√ó</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB28uLNC-7NBDBSJeQJ1Li_bYR6ygbf0DI",
    authDomain: "transferencia-88fd7.firebaseapp.com",
    databaseURL: "https://transferencia-88fd7-default-rtdb.firebaseio.com",
    projectId: "transferencia-88fd7",
    storageBucket: "transferencia-88fd7.firebasestorage.app",
    messagingSenderId: "343352831024",
    appId: "1:343352831024:web:9ac2d08b41874b15e611f5"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const fs = firebase.firestore();
  const rtdb = firebase.database();

  const $ = s => document.querySelector(s);
  const statusBox = $('#status');
  const show = (cls, msg) => { statusBox.className = 'status ' + cls; statusBox.innerHTML = msg; };
  const wait = ms => new Promise(res => setTimeout(res, ms));
  const COSTO = 3;

  function renderModal(data){
    const m = $('#modal'); const body = $('#modalBody');
    const N = (x)=> (x==null || x==='') ? '‚Äî' : x;
    body.innerHTML = `
      <div class="cols">
        <div class="blk">
          <h3>Identidad</h3>
          <div class="item"><span class="hl">DNI:</span> ${N(data.dni)}</div>
          <div class="item"><span class="hl">NOMBRES:</span> ${N(data.nombres)}</div>
          <div class="item"><span class="hl">APELLIDOS:</span> ${N(data.apellidos)}</div>
          <div class="item"><span class="hl">G√âNERO:</span> ${N(data.genero)}</div>
        </div>
        <div class="blk">
          <h3>üéÇ Nacimiento</h3>
          <div class="item"><span class="hl">FECHA NACIMIENTO:</span> ${N(data.nacimiento?.fecha)}</div>
          <div class="item"><span class="hl">EDAD:</span> ${N(data.nacimiento?.edad)}</div>
          <div class="item"><span class="hl">DEPARTAMENTO:</span> ${N(data.nacimiento?.departamento)}</div>
          <div class="item"><span class="hl">PROVINCIA:</span> ${N(data.nacimiento?.provincia)}</div>
          <div class="item"><span class="hl">DISTRITO:</span> ${N(data.nacimiento?.distrito)}</div>
        </div>
        <div class="blk">
          <h3>üìã Informaci√≥n general</h3>
          <div class="item"><span class="hl">NIVEL EDUCATIVO:</span> ${N(data.general?.nivelEducativo)}</div>
          <div class="item"><span class="hl">ESTADO CIVIL:</span> ${N(data.general?.estadoCivil)}</div>
          <div class="item"><span class="hl">ESTATURA:</span> ${N(data.general?.estatura)}</div>
          <div class="item"><span class="hl">FECHA INSCRIPCI√ìN:</span> ${N(data.general?.fechaInscripcion)}</div>
          <div class="item"><span class="hl">FECHA EMISI√ìN:</span> ${N(data.general?.fechaEmision)}</div>
          <div class="item"><span class="hl">FECHA CADUCIDAD:</span> ${N(data.general?.fechaCaducidad)}</div>
          <div class="item"><span class="hl">DONANTE √ìRGANOS:</span> ${N(data.general?.donanteOrganos)}</div>
          <div class="item"><span class="hl">PADRE:</span> ${N(data.general?.padre)}</div>
          <div class="item"><span class="hl">MADRE:</span> ${N(data.general?.madre)}</div>
          <div class="item"><span class="hl">RESTRICCI√ìN:</span> ${N(data.general?.restriccion)}</div>
        </div>
        <div class="blk">
          <h3>üè† Domicilio</h3>
          <div class="item"><span class="hl">DEPARTAMENTO:</span> ${N(data.domicilio?.departamento)}</div>
          <div class="item"><span class="hl">PROVINCIA:</span> ${N(data.domicilio?.provincia)}</div>
          <div class="item"><span class="hl">DISTRITO:</span> ${N(data.domicilio?.distrito)}</div>
          <div class="item"><span class="hl">DIRECCI√ìN:</span> ${N(data.domicilio?.direccion)}</div>
        </div>
        <div class="blk">
          <h3>üìç Ubigeos</h3>
          <div class="item"><span class="hl">UBIGEO RENIEC:</span> ${N(data.ubigeos?.reniec)}</div>
          <div class="item"><span class="hl">UBIGEO INE:</span> ${N(data.ubigeos?.ine)}</div>
          <div class="item"><span class="hl">UBIGEO SUNAT:</span> ${N(data.ubigeos?.sunat)}</div>
        </div>
      </div>
    `;
    m.classList.add('show');
  }

  $('#closeModal').addEventListener('click', ()=> $('#modal').classList.remove('show'));

  $('#btnBuscar').addEventListener('click', async ()=>{
    const dni = ($('#dniInput').value || '').trim();
    if (!dni) { show('warn','‚ö†Ô∏è Ingresa un DNI.'); return; }

    const user = auth.currentUser;
    if (!user) { show('warn','‚ö†Ô∏è Debes iniciar sesi√≥n.'); return; }

    show('loading','‚è≥ Procesando datos...');
    await wait(2000);
    show('loading','‚öôÔ∏è Generando informaci√≥n...');
    await wait(2000);

    try{
      const snap = await fs.collection('doxin').doc(dni).get();
      if (!snap.exists){
        show('warn','‚ùå No hay informaci√≥n en la base de datos para ese DNI.');
        return;
      }

      const uSnap = await rtdb.ref(`usuarios/${user.uid}/comisionesTotales`).once('value');
      let saldo = Number(uSnap.val() || 0);

      if (saldo < COSTO){
        show('warn','‚ùå No tienes cr√©ditos suficientes.');
        return;
      }

      await rtdb.ref(`usuarios/${user.uid}/comisionesTotales`).set(saldo - COSTO);

      show('ok','‚úÖ Consulta lista.');
      renderModal(snap.data());

    }catch(e){
      console.error(e);
      show('err','‚ùå Error en la consulta.');
    }
  });
</script>
</body>
</html>
