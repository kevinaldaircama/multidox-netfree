<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Registro con Referido</title>
<style>
body{font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;background:#f3f3f3;}
form{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);width:100%;max-width:360px;}
input{width:100%;padding:10px;margin-bottom:12px;border:1px solid #ccc;border-radius:6px;}
button{width:100%;padding:12px;background:#4caf50;color:#fff;border:none;border-radius:6px;font-size:1rem;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<form id="registerForm">
  <h2>Crear cuenta</h2>
  <input type="text" id="nombre" placeholder="Tu nombre (usuario)" required>
  <input type="email" id="correo" placeholder="Correo" required>
  <input type="password" id="clave" placeholder="Contraseña" required>
  <button type="submit">Registrarme</button>
</form>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB28uLNC-7NBDBSJeQJ1Li_bYR6ygbf0DI",
  authDomain: "transferencia-88fd7.firebaseapp.com",
  databaseURL: "https://transferencia-88fd7-default-rtdb.firebaseio.com",
  projectId: "transferencia-88fd7",
  storageBucket: "transferencia-88fd7.appspot.com",
  messagingSenderId: "343352831024",
  appId: "1:343352831024:web:9ac2d08b41874b15e611f5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Obtener padrino si viene en URL ?ref=Carlos
const urlParams = new URLSearchParams(window.location.search);
const refPadrino = urlParams.get('ref'); // Ej: Carlos

document.getElementById('registerForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const nombre = document.getElementById('nombre').value.trim();
  const correo = document.getElementById('correo').value.trim();
  const clave = document.getElementById('clave').value.trim();

  try {
    const cred = await auth.createUserWithEmailAndPassword(correo, clave);
    const uid = cred.user.uid;

    // Guardar usuario nuevo con 5 créditos iniciales
    await db.ref(`usuarios/${nombre}`).set({
      nombre: nombre,
      correo: correo,
      uid: uid,
      comisionesTotales: 5,
      comisionesPendientes: 0,
      fechaRegistro: new Date().toISOString().split('T')[0]
    });

    // Si viene con padrino, agregar en /referidos/{padrino}/{uid}
    if(refPadrino){
      await db.ref(`referidos/${refPadrino}/${uid}`).set({
        nombre: nombre,
        correo: correo,
        fecha: new Date().toISOString().split('T')[0],
        estado: 'activo'
      });

      // Sumar 10 créditos al padrino
      const snapPad = await db.ref(`usuarios/${refPadrino}/comisionesTotales`).once('value');
      const credPad = Number(snapPad.val() || 0);
      await db.ref(`usuarios/${refPadrino}/comisionesTotales`).set(credPad + 10);
    }

    alert('Cuenta creada con éxito');
    location.href = 'panel.html';
  } catch (err) {
    console.error(err);
    alert('Error: ' + err.message);
  }
});
</script>
</body>
</html>
