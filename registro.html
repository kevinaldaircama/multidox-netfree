<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Registro · Transferencia VIP</title>
  <link rel="icon" href="3440119_ico.png"/><link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#0f2027"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      background: linear-gradient(-45deg,#0f2027,#203a43,#2c5364) no-repeat center/400% 400%;
      display:grid;place-items:center;height:100vh;margin:0;
      animation:bgmove 18s ease infinite;
    }
    @keyframes bgmove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .container { background:#fff; padding:28px 24px; border-radius:16px; width:100%;max-width:420px;box-shadow:0 18px 42px rgba(0,0,0,0.22); }
    .brand { display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:10px; }
    .brand img { width:54px;height:54px;border-radius:12px; }
    h1 { font-size:1.35rem; margin:0; }
    p.sub { text-align:center; color:#5b708b; margin:6px 0 18px;}
    form{display:grid;gap:12px;}
    .field{display:grid;gap:6px;}
    label{font-weight:600;font-size:.92rem;}
    input{padding:12px; border:1px solid #d7dce3; border-radius:8px; font-size:15px;}
    input:focus{outline:none;border-color:#007bff;box-shadow:0 0 0 4px rgba(0,123,255,.25);}
    button{padding:12px;border:none;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer;}
    .btn-submit{background:#007bff;color:#fff;}
    .btn-submit:hover{background:#0056b3;}
    .alert{display:none;padding:10px;margin-bottom:10px;border-radius:6px;background:#fff4f4;color:#8a1f1f;border:1px solid #ffd6d6;}
    .alert.show{display:block;}
    .google-btn{background:#fff;border:1px solid #d7dce3;display:flex;align-items:center;justify-content:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;margin-top:8px;}
    .google-btn:hover{box-shadow:0 0 0 4px rgba(0,0,0,.05);}
    .google-icon{width:20px;height:20px;}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js" defer></script>
</head>
<body>
  <div class="container">
    <div class="brand">
      <img src="3440119_ico.png" alt="Logo"/>
      <h1>Registro</h1>
    </div>
    <p class="sub">Crea tu cuenta y recibe créditos de bienvenida.</p>
    <div class="alert" id="alertBox"></div>
    <form id="registerForm">
      <div class="field"><label>Nombre de usuario</label><input id="regUsername" type="text" required minlength="3"/></div>
      <div class="field"><label>Nombre completo</label><input id="regFullName" type="text" required minlength="3"/></div>
      <div class="field"><label>Correo electrónico</label><input id="regEmail" type="email" required/></div>
      <div class="field"><label>Contraseña</label><input id="regPass" type="password" required minlength="6"/></div>
      <button type="submit" class="btn-submit">Registrarse</button>
    </form>
    <div class="google-btn" id="googleBtn">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="google-icon"/>
      Registrarse con Google
    </div>
  </div>

  <script>
    const showAlert = msg => {
      const b = document.getElementById("alertBox");
      b.textContent = msg;
      b.classList.add("show");
      setTimeout(()=>b.classList.remove("show"),4000);
    };
    const getParam = k => new URLSearchParams(location.search).get(k);

    const REF_KEY = "multidox-netfree";
    function getReferralFromURL(){
      const q = getParam("ref");
      if (q) return q;
      const p = location.pathname.split("/").filter(x=>x);
      const i = p.findIndex(x=>x.toLowerCase()==="referido");
      return (i>=0 && p[i+1]) ? p[i+1] : "";
    }
    function setStoredRef(c){ try{ localStorage.setItem(REF_KEY,c);}catch(e){}}
    function getStoredRef(){ try{ return localStorage.getItem(REF_KEY)||"";}catch(e){return ""}}
    (()=>{
      const c = getReferralFromURL();
      if (c) setStoredRef(c);
    })();

    document.addEventListener("DOMContentLoaded",()=>{
      const firebaseConfig = {
        apiKey: "AIzaSyB28uLNC-7NBDBSJeQJ1Li_bYR6ygbf0DI",
        authDomain: "transferencia-88fd7.firebaseapp.com",
        databaseURL: "https://transferencia-88fd7-default-rtdb.firebaseio.com",
        projectId: "transferencia-88fd7",
        storageBucket: "transferencia-88fd7.appspot.com",
        messagingSenderId: "343352831024",
        appId: "1:343352831024:web:9ac2d08b41874b15e611f5"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth(), db = firebase.database();

      async function resolveOwner(code){
        if (!code) return null;
        const snap = await db.ref("usuarios").orderByChild("referidoId").equalTo(code).limitToFirst(1).once("value");
        if (!snap.exists()) return null;
        const e = snap.val();
        const ownerUid = Object.keys(e)[0];
        const ownerUsername = e[ownerUid].nombre||ownerUid;
        return {ownerUid, ownerUsername};
      }

      async function registrar({user, email, username, fullName, isGoogle=false}){
        const uid = user.uid;
        const fecha = new Date().toISOString().split("T")[0];
        const refCode = getStoredRef();

        let creditNew = 5, bonus = 10;

        const referidoId = uid.slice(0,2) + Math.floor(Math.random()*100) + uid.slice(-2);

        const data = {
          nombre: username,
          nombreCompleto: fullName,
          correo: email,
          fechaRegistro: fecha,
          estado: "activo",
          comisionesTotales: creditNew,
          comisionesPendientes: 0,
          saldo: 0,
          ultima: fecha,
          referidoId
        };
        if(isGoogle) data.google = true;

        const updates = {};
        updates[`usuarios/${uid}`] = data;

        if (refCode) {
          const owner = await resolveOwner(refCode);
          if(owner){
            updates[`referido/${owner.ownerUsername}/${uid}`] = {
              "Comisión": "Pendiente",
              "Correo": email,
              "Estado": "activo",
              "Fecha recargas": fecha,
              "Saldo": 0,
              "Última": fecha
            };
            updates[`usuarios/${owner.ownerUid}/comisionesTotales`] = firebase.database.ServerValue.increment(bonus);
          }
        }

        await db.ref().update(updates);
      }

      document.getElementById("registerForm").addEventListener("submit", async e=>{
        e.preventDefault();
        const username = document.getElementById("regUsername").value.trim();
        const fullName = document.getElementById("regFullName").value.trim();
        const email = document.getElementById("regEmail").value.trim().toLowerCase();
        const pass = document.getElementById("regPass").value;

        if(!username || !fullName || !email || !pass){
          showAlert("Completa todos los campos.");
          return;
        }

        try {
          const cred = await auth.createUserWithEmailAndPassword(email,pass);
          await registrar({user:cred.user,email,username,fullName,isGoogle:false});
          alert("Registro exitoso");
          auth.signOut();
          location.href="inicio.html";
        } catch(err) {
          console.error(err);
          showAlert(err.message);
        }
      });

      document.getElementById("googleBtn").addEventListener("click", async()=>{
        try{
          const result = await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
          const user = result.user;
          let username = (user.email?.split("@")[0]||"usr") + Math.random().toString(36).slice(2,5);
          await registrar({user,email:user.email||"",username,fullName:user.displayName||username,isGoogle:true});
          alert("Cuenta creada");
          auth.signOut();
          location.href="inicio.html";
        }catch(err){
          console.error(err);
          showAlert(err.message||"Error con Google");
        }
      });
    });
  </script>
</body>
</html>
